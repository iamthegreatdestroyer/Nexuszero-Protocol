name: Kani CI

on:
  pull_request:
    paths:
      - "nexuszero-crypto/**"
      - ".github/workflows/kani.yml"
  push:
    paths:
      - "nexuszero-crypto/**"
      - ".github/workflows/kani.yml"
  schedule:
    - cron: "0 3 * * 1" # Weekly Monday run for deeper checks (full workspace)

jobs:
  kani-matrix:
    # Single job with matrix to test multiple Rust channels (stable, beta)
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta]
        mode: [full, quick]
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Select harness set
        id: harness_args
        run: |
          if [ "${{ matrix.mode }}" = "quick" ]; then
            echo "ARGS=--tests --harness verify_ct_modpow_small_equivalence --output-format=terse" >> $GITHUB_OUTPUT
          else
            echo "ARGS=--tests --output-format=terse" >> $GITHUB_OUTPUT
          fi

      - name: Run Kani proofs
        uses: model-checking/kani-github-action@v1
        with:
          kani-version: "latest"
          command: "cargo-kani"
          working-directory: nexuszero-crypto
          args: ${{ steps.harness_args.outputs.ARGS }}

      - name: Archive Kani artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kani-${{ matrix.rust }}-${{ matrix.mode }}
          path: |
            nexuszero-crypto/kani-report/**
            nexuszero-crypto/kani-artifacts/**
          if-no-files-found: ignore
