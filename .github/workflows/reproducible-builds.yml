name: Reproducible Builds

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write # For artifact signing

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUST_BACKTRACE: short
  RUSTFLAGS: "-D warnings"
  # Ensure reproducible builds
  SOURCE_DATE_EPOCH: 0

jobs:
  # ============================================================================
  # Verify Lockfiles Exist and Are Up-to-Date
  # ============================================================================
  verify-lockfiles:
    name: Verify Lockfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Cargo.lock exists
        run: |
          if [ ! -f Cargo.lock ]; then
            echo "::error::Cargo.lock is missing! Run 'cargo generate-lockfile' and commit it."
            exit 1
          fi
          echo "✅ Cargo.lock exists"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.lock is up-to-date
        run: |
          cargo generate-lockfile --locked || {
            echo "::error::Cargo.lock is out of sync with Cargo.toml. Run 'cargo generate-lockfile' and commit."
            exit 1
          }
          echo "✅ Cargo.lock is in sync"

      - name: Check package-lock.json files
        run: |
          for dir in nexuszero-sdk docs-site examples/node-app frontend/web; do
            if [ -f "$dir/package.json" ]; then
              if [ ! -f "$dir/package-lock.json" ]; then
                echo "::error::$dir/package-lock.json is missing!"
                exit 1
              fi
              echo "✅ $dir/package-lock.json exists"
            fi
          done

      - name: Verify npm lockfiles are in sync
        run: |
          for dir in nexuszero-sdk docs-site examples/node-app frontend/web; do
            if [ -f "$dir/package.json" ] && [ -f "$dir/package-lock.json" ]; then
              cd "$dir"
              npm ci --ignore-scripts || {
                echo "::error::$dir/package-lock.json is out of sync!"
                exit 1
              }
              cd - > /dev/null
              echo "✅ $dir npm lockfile is in sync"
            fi
          done

  # ============================================================================
  # Rust Reproducible Build
  # ============================================================================
  rust-reproducible-build:
    name: Rust Reproducible Build
    runs-on: ubuntu-latest
    needs: verify-lockfiles
    strategy:
      matrix:
        rust: [stable, "1.75.0"] # Pin specific versions
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo registry & target
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          key: reproducible-${{ matrix.rust }}

      - name: Build with locked dependencies
        run: |
          cargo build --release --workspace --locked
        env:
          RUSTFLAGS: "-D warnings --remap-path-prefix=${{ github.workspace }}=/build"

      - name: Calculate build hash (first build)
        id: hash1
        run: |
          find target/release -maxdepth 1 -type f -executable -exec sha256sum {} \; | sort > build-hash-1.txt
          echo "hash=$(sha256sum build-hash-1.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Clean and rebuild
        run: |
          cargo clean
          cargo build --release --workspace --locked
        env:
          RUSTFLAGS: "-D warnings --remap-path-prefix=${{ github.workspace }}=/build"

      - name: Calculate build hash (second build)
        id: hash2
        run: |
          find target/release -maxdepth 1 -type f -executable -exec sha256sum {} \; | sort > build-hash-2.txt
          echo "hash=$(sha256sum build-hash-2.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Verify reproducibility
        run: |
          if [ "${{ steps.hash1.outputs.hash }}" != "${{ steps.hash2.outputs.hash }}" ]; then
            echo "::warning::Build is not perfectly reproducible between runs"
            diff build-hash-1.txt build-hash-2.txt || true
          else
            echo "✅ Build is reproducible!"
          fi

      - name: Upload build artifacts with hashes
        uses: actions/upload-artifact@v4
        with:
          name: rust-build-${{ matrix.rust }}
          path: |
            target/release/nexuszero-*
            build-hash-1.txt
            build-hash-2.txt
          retention-days: 30

  # ============================================================================
  # TypeScript Reproducible Build
  # ============================================================================
  typescript-reproducible-build:
    name: TypeScript Reproducible Build
    runs-on: ubuntu-latest
    needs: verify-lockfiles
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.10.0" # Pin exact version
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies with frozen lockfile
        working-directory: nexuszero-sdk
        run: npm ci --ignore-scripts

      - name: Build SDK
        working-directory: nexuszero-sdk
        run: npm run build

      - name: Calculate build hash
        id: hash
        working-directory: nexuszero-sdk
        run: |
          find dist -type f -exec sha256sum {} \; | sort > ../ts-build-hash.txt
          echo "hash=$(sha256sum ../ts-build-hash.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Upload TypeScript build
        uses: actions/upload-artifact@v4
        with:
          name: typescript-build
          path: |
            nexuszero-sdk/dist
            ts-build-hash.txt
          retention-days: 30

  # ============================================================================
  # Docker Reproducible Build
  # ============================================================================
  docker-reproducible-build:
    name: Docker Reproducible Build
    runs-on: ubuntu-latest
    needs: [rust-reproducible-build, typescript-reproducible-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with deterministic settings
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: nexuszero-crypto:reproducible
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SOURCE_DATE_EPOCH=0
            RUSTFLAGS=-D warnings --remap-path-prefix=/app=/build
          outputs: type=docker,dest=/tmp/nexuszero-crypto.tar

      - name: Calculate Docker image hash
        run: |
          sha256sum /tmp/nexuszero-crypto.tar > docker-image-hash.txt
          cat docker-image-hash.txt

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: |
            /tmp/nexuszero-crypto.tar
            docker-image-hash.txt
          retention-days: 7

  # ============================================================================
  # Generate Build Provenance
  # ============================================================================
  build-provenance:
    name: Generate Build Provenance
    runs-on: ubuntu-latest
    needs:
      [
        rust-reproducible-build,
        typescript-reproducible-build,
        docker-reproducible-build,
      ]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate provenance
        run: |
          cat > provenance.json << EOF
          {
            "builder": {
              "id": "github-actions"
            },
            "buildType": "https://github.com/iamthegreatdestroyer/Nexuszero-Protocol/blob/main/.github/workflows/reproducible-builds.yml",
            "invocation": {
              "configSource": {
                "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                },
                "entryPoint": ".github/workflows/reproducible-builds.yml"
              },
              "parameters": {},
              "environment": {
                "github_actor": "${{ github.actor }}",
                "github_event_name": "${{ github.event_name }}",
                "runner_os": "${{ runner.os }}"
              }
            },
            "metadata": {
              "buildInvocationId": "${{ github.run_id }}",
              "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": true,
                "materials": true
              },
              "reproducible": true
            },
            "materials": [
              {
                "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF

      - name: Upload provenance
        uses: actions/upload-artifact@v4
        with:
          name: build-provenance
          path: provenance.json
          retention-days: 90

  # ============================================================================
  # Release Artifacts with Signatures
  # ============================================================================
  release-artifacts:
    name: Release with Signatures
    runs-on: ubuntu-latest
    needs: [build-provenance]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.tar" -o -name "nexuszero-*" \) -exec sha256sum {} \; > SHA256SUMS.txt
          find . -type f \( -name "*.tar" -o -name "nexuszero-*" \) -exec sha512sum {} \; > SHA512SUMS.txt

      - name: Sign checksums with cosign (keyless)
        run: |
          cd artifacts
          cosign sign-blob --yes SHA256SUMS.txt --bundle SHA256SUMS.txt.bundle
          cosign sign-blob --yes SHA512SUMS.txt --bundle SHA512SUMS.txt.bundle

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/SHA256SUMS.txt
            artifacts/SHA256SUMS.txt.bundle
            artifacts/SHA512SUMS.txt
            artifacts/SHA512SUMS.txt.bundle
            artifacts/build-provenance/provenance.json
          generate_release_notes: true
