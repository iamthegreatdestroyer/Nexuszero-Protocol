name: Nightly Coverage

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Run coverage update script
        shell: pwsh
        run: |
          ./scripts/update-coverage.ps1 -WorkspacePath . -FailUnder 90

      - name: Generate coverage badge
        shell: pwsh
        run: |
          ./scripts/update-badge.ps1

      - name: Set up Python for optimizer coverage
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyTorch CPU and deps
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir \
            torch==2.1.0+cpu \
            torchvision==0.16.0+cpu \
            torchaudio==2.1.0+cpu \
            -f https://download.pytorch.org/whl/torch_stable.html

      - name: Install PyG wheels and torch-geometric
        run: |
          pip install --no-cache-dir \
            pyg_lib \
            torch_scatter \
            torch_sparse \
            torch_cluster \
            torch_spline_conv \
            -f https://data.pyg.org/whl/torch-2.1.0+cpu.html
          pip install --no-cache-dir torch-geometric>=2.4.0

      - name: Install optimizer package (dev) and pytest-cov
        run: |
          pip install -e nexuszero-optimizer/[dev]
          pip install pytest-cov

      - name: Update Python coverage history and badge
        shell: pwsh
        run: |
          ./scripts/update-python-coverage.ps1 -WorkspacePath . -FailUnder 90

      - name: Upload Python coverage XML artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-main
          path: nexuszero-optimizer/coverage.xml

      - name: Commit and push if changed
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/coverage/HISTORY.md docs/coverage/badge.svg README.md docs/coverage/python/HISTORY.md docs/coverage/python/badge.svg
          $changed = git diff --staged --quiet; $LASTEXITCODE -ne 0
          if ($changed) {
            $date = Get-Date -Format "yyyy-MM-dd"
            git commit -m "chore(coverage): nightly coverage update for $date [skip ci]"
            git push
          } else {
            Write-Host "No coverage changes to commit"
          }
