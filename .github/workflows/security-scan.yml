name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Rust Dependency Security Audit
  # ============================================================================
  rust-security-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo audit
        run: |
          cargo audit --json > cargo-audit-results.json || true
          cargo audit 2>&1 | tee cargo-audit.log || true
        continue-on-error: true

      - name: Run cargo deny
        run: |
          cargo deny check advisories 2>&1 | tee cargo-deny.log || true
        continue-on-error: true

      - name: Upload Rust audit results
        uses: actions/upload-artifact@v4
        with:
          name: rust-security-audit
          path: |
            cargo-audit-results.json
            cargo-audit.log
            cargo-deny.log
          retention-days: 30

      - name: Check for critical vulnerabilities
        run: |
          if grep -q "RUSTSEC-" cargo-audit.log; then
            echo "::warning::Security vulnerabilities found in Rust dependencies. Check the audit logs."
          fi

  # ============================================================================
  # TypeScript/Node.js Dependency Security Audit
  # ============================================================================
  npm-security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory:
          - nexuszero-sdk
          - docs-site
          - examples/node-app
          - frontend/web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check if package.json exists
        id: check-package
        run: |
          if [ -f "${{ matrix.directory }}/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-package.outputs.exists == 'true'
        working-directory: ${{ matrix.directory }}
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Run npm audit
        if: steps.check-package.outputs.exists == 'true'
        working-directory: ${{ matrix.directory }}
        run: |
          npm audit --json > npm-audit-results.json 2>&1 || true
          npm audit 2>&1 | tee npm-audit.log || true
        continue-on-error: true

      - name: Upload NPM audit results
        if: steps.check-package.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: npm-security-audit-${{ matrix.directory }}
          path: |
            ${{ matrix.directory }}/npm-audit-results.json
            ${{ matrix.directory }}/npm-audit.log
          retention-days: 30

  # ============================================================================
  # Python Dependency Security Audit
  # ============================================================================
  python-security-audit:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install safety and pip-audit
        run: |
          pip install safety pip-audit

      - name: Run safety check on requirements.txt
        run: |
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt --json > safety-results.json 2>&1 || true
            safety check -r requirements.txt 2>&1 | tee safety.log || true
          fi
        continue-on-error: true

      - name: Run pip-audit on nexuszero-optimizer
        run: |
          if [ -f nexuszero-optimizer/requirements.txt ]; then
            pip-audit -r nexuszero-optimizer/requirements.txt --format json > pip-audit-results.json 2>&1 || true
            pip-audit -r nexuszero-optimizer/requirements.txt 2>&1 | tee pip-audit.log || true
          fi
        continue-on-error: true

      - name: Upload Python audit results
        uses: actions/upload-artifact@v4
        with:
          name: python-security-audit
          path: |
            safety-results.json
            safety.log
            pip-audit-results.json
            pip-audit.log
          retention-days: 30

  # ============================================================================
  # Container Image Scanning
  # ============================================================================
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [rust-security-audit, npm-security-audit]
    if: github.event_name != 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Rust container for scanning
        run: |
          docker build -t nexuszero-crypto:scan -f Dockerfile . || true

      - name: Run Trivy vulnerability scanner on Rust image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "nexuszero-crypto:scan"
          format: "sarif"
          output: "trivy-rust-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
        continue-on-error: true

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-fs-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-fs-results.sarif"
          category: "trivy-filesystem"

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-security-scan
          path: |
            trivy-rust-results.sarif
            trivy-fs-results.sarif
          retention-days: 30

  # ============================================================================
  # License Compliance Check
  # ============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license --locked

      - name: Check Rust licenses
        run: |
          cargo license --json > rust-licenses.json || true
          cargo license 2>&1 | tee rust-licenses.log
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check NPM licenses
        run: |
          if [ -f nexuszero-sdk/package.json ]; then
            cd nexuszero-sdk && npm ci --ignore-scripts && license-checker --json > ../npm-licenses.json 2>&1 || true
          fi
        continue-on-error: true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-compliance
          path: |
            rust-licenses.json
            rust-licenses.log
            npm-licenses.json
          retention-days: 30

  # ============================================================================
  # SBOM Generation
  # ============================================================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.spdx.json
            sbom.cyclonedx.json
          retention-days: 90

  # ============================================================================
  # Secret Scanning
  # ============================================================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          extra_args: --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ============================================================================
  # Security Summary Report
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        rust-security-audit,
        npm-security-audit,
        python-security-audit,
        container-scan,
        license-check,
        secret-scan,
      ]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Audit | ${{ needs.rust-security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Audit | ${{ needs.python-security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Detailed reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
